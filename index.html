
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>√ìptica Cristal ‚Ä¢ Lista de trabajos</title>
  <meta name="theme-color" content="#0b1220" />
  <link rel="icon" href="logo.png" />
  <style>
    :root{
      --bg:#0b1220; --panel:#0f172a; --muted:#334155; --text:#e5e7eb; --soft:#94a3b8; --primary:#22c55e;
      --danger:#ef4444; --warn:#f59e0b; --ok:#10b981; --row:#0b1326; --rowAlt:#0c152c;
    }

  /* Sem√°foro por fecha de entrega */
  .tableWrap table tbody tr.ready{ background:#0b2a1a !important; }
  .tableWrap table tbody tr.alert-orange{ background:#2a1f0b !important; }
  .tableWrap table tbody tr.alert-red{ background:#2a0b0b !important; }
  .tableWrap table tbody tr.ready td,
  .tableWrap table tbody tr.alert-orange td,
  .tableWrap table tbody tr.alert-red td{ border-bottom-color: rgba(255,255,255,.06); }


    *{box-sizing:border-box}
    html,body{height:100%; margin:0}
    body{background:var(--bg); color:var(--text); font:14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif}
    .wrap{max-width:1200px; margin:0 auto; padding:16px}
    header{display:grid; gap:12px; grid-template-columns:1fr; margin-bottom:12px}
    .toolbar{display:flex; flex-wrap:wrap; gap:8px; align-items:center}
    .card{background:var(--panel); border:1px solid #1e293b; border-radius:14px; padding:12px; box-shadow:0 2px 16px rgba(0,0,0,.25)}
    input, select, button{background:#0b1326; border:1px solid #1f2a44; color:var(--text); border-radius:10px; padding:8px 10px; outline:none}
    input::placeholder{color:#7085a3}
    button{cursor:pointer}
    button.primary{background:linear-gradient(180deg,#22c55e,#16a34a); border-color:#0f3b23; font-weight:600}
    button.ghost{background:transparent}
    .kpi{display:flex; gap:12px; align-items:center; color:var(--soft)}
    .kpi b{color:var(--text)}

    /* tabla */
    .tableWrap{height: calc(100vh - 190px); min-height:360px; overflow:auto; border:1px solid #1e293b; border-radius:12px}
    table{width:100%; border-collapse:separate; border-spacing:0}
    thead th{position:sticky; top:0; background:#0a1222; z-index:2; text-align:left; padding:10px 8px; font-weight:600; font-size:12px; color:#9fb3d1; border-bottom:1px solid #1e293b}
    tbody td{padding:10px 8px; border-bottom:1px solid #14223b; white-space:nowrap}
    tbody tr:nth-child(odd){background:var(--row)}
    tbody tr:nth-child(even){background:var(--rowAlt)}
    .state{padding:.2em .6em; border-radius:999px; font-size:12px; border:1px solid #2b3855}
    .state.OK{background:#0b2a1a; color:#86efac; border-color:#14532d}
    .state.PEND{background:#2a130b; color:#fdba74; border-color:#7c2d12}
    .state.LAB{background:#0b1f2a; color:#93c5fd; border-color:#1e3a8a}

    .right{ text-align:right }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace }
    .muted{ color: var(--soft) }
    .pill{ background:#0b1326; border:1px solid #20314f; padding:.35em .7em; border-radius:999px }
    .grow{ flex:1 }
    .spacer{flex:1}

    .footer{display:flex; gap:8px; align-items:center; justify-content:space-between; color:var(--soft); margin-top:10px}

    .progress{display:none; gap:12px; align-items:center}
    .progress.show{display:flex}
    .dot{width:9px;height:9px;border-radius:50%;background:#60a5fa; box-shadow:0 0 0 3px rgba(96,165,250,.15)}
    .spinner{display:inline-block; width:16px; height:16px; border:2px solid #284064; border-top-color:#93c5fd; border-radius:50%; animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(1turn)}}

    @media (min-width: 860px){
      header{grid-template-columns: 1fr auto}
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="card">
        <div class="toolbar">
          <strong style="font-size:18px">üìã Lista de trabajos</strong>
          <span class="pill muted">scroll infinito</span>
          <span class="spacer"></span>
          <div class="kpi" id="kpi">
            <span>Mostrando <b id="count">0</b> de <b id="total">‚Äî</b></span>
          </div>
        </div>
        <div class="toolbar" style="margin-top:8px">
          <input id="q" class="grow" placeholder="Buscar por N¬∞ trabajo, DNI, nombre o detalle‚Ä¶" />
          <select id="limit">
            <option value="100">100</option>
            <option value="200">200</option>
            <option value="500">500</option>
            <option value="1000">1000</option>
          </select>
          <button id="btnLoad" class="primary">Cargar</button>
          <button id="btnClear" class="ghost">Limpiar</button>
        </div>
        <div id="progress" class="progress" style="margin-top:6px">
          <span class="spinner"></span>
          <span class="muted">Cargando‚Ä¶</span>
        </div>
      </div>

      <div class="card" style="min-width:260px">
        <div class="toolbar">
          <label class="muted">Orden:</label>
          <select id="sort">
            <option value="fecha_desc">Fecha ‚Üì (recientes primero)</option>
            <option value="fecha_asc">Fecha ‚Üë (antiguos primero)</option>
            <option value="num_desc">N¬∞ trabajo ‚Üì</option>
            <option value="num_asc">N¬∞ trabajo ‚Üë</option>
          </select>
          <span class="spacer"></span>
          <button id="exportCsv" title="Exportar a CSV" class="ghost">‚¨áÔ∏è Exportar</button>
        </div>
        <small class="muted">Tip: pod√©s escribir y presionar Enter para filtrar. Con el scroll se cargan m√°s.</small>
      </div>
    </header>

    <div class="tableWrap" id="scroller">
      <table>
        <thead>
          <tr>
            <th style="width:90px">Fecha</th>
            <th style="width:110px">N¬∞</th>
            <th>Paciente</th>
            <th style="width:120px">DNI</th>
            <th style="width:120px">Tel√©fono</th>
            <th>Armaz√≥n</th>
            <th>Cristal</th>
            <th class="right" style="width:110px">Total</th>
            <th class="right" style="width:90px">Se√±a</th>
            <th class="right" style="width:90px">Saldo</th>
            <th style="width:110px">Estado</th>
            <th style="width:110px">Retira</th>
            <th style="width:110px">Vendedor</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <div class="footer">
      <div id="hint" class="muted">Desplazate para cargar m√°s‚Ä¶</div>
      <div id="pageInfo" class="muted"></div>
    </div>
  </div>

<script type="module">
/*****************************
 * CONFIGURACI√ìN API (histUltimos / histBuscar)
 *****************************/
const API_URL = 'https://script.google.com/macros/s/AKfycby6SzAgXhtctDbYEGETB6Ku8X_atugp7Mld5QvimnDpXMmHU9IxW9XRqDkRI0rGONr85Q/exec';

/*****************************
 * HELPERS
 *****************************/
const $ = (id) => document.getElementById(id);
const debounce = (fn, ms=300) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms) } };
const todayLocal = () => { const d=new Date(); d.setHours(0,0,0,0); return d; };
const safe = (v) => (v??'').toString().trim();

function parseDateDMY(str){
  const s = (str||'').trim(); if(!s) return null;
  const m = s.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{2,4})$/);
  if(!m) return null;
  let dd=+m[1], mm=+m[2], yy=+m[3]; if(yy<100) yy+=2000;
  const d = new Date(yy, mm-1, dd, 0,0,0,0);
  return Number.isNaN(d.getTime()) ? null : d;
}
function daysUntil(dateStr){
  const d = parseDateDMY(dateStr); if(!d) return Number.POSITIVE_INFINITY;
  const base = todayLocal();
  const ms = d.getTime() - base.getTime();
  return Math.floor(ms / 86400000);
}
function isReady(estado){ return /\bLISTO\b/i.test(String(estado||'')); }

/*****************************
 * ESTADO
 *****************************/
let state = {
  items: [],
  total: 0,
  limitLoaded: 0,
  pageStep: 100,
  query: '',
  loading: false
};

/*****************************
 * API CLIENT (histUltimos / histBuscar)
 *****************************/
function buildURL(){
  const qp = new URLSearchParams();
  if(state.query){
    qp.set('histBuscar', state.query);
    qp.set('limit', String(state.limitLoaded||state.pageStep));
  } else {
    qp.set('histUltimos', String(state.limitLoaded||state.pageStep));
  }
  return API_URL + '?' + qp.toString();
}

async function fetchTrabajos(){
  if(state.loading) return;
  state.loading = true; toggleProgress(true);
  try{
    const url = buildURL();
    const res = await fetch(url, { method:'GET' });
    if(!res.ok) throw new Error('HTTP '+res.status);
    const data = await res.json();
    const items = Array.isArray(data) ? data : (Array.isArray(data.items)?data.items:[]);
    state.items = items.map(mapFromAPI);
    state.total  = items.length; // el endpoint no devuelve total global
    sortItems();
    render();
  }catch(err){
    console.error(err);
    alert('No pude cargar los trabajos.');
  }finally{
    state.loading = false; toggleProgress(false);
  }
}

function mapFromAPI(it){
  return {
    estado: safe(it.estado),
    fecha:  safe(it.fecha),
    retira: safe(it.retira),
    numero: safe(it.numero),
    dni:    safe(it.dni),
    nombre: safe(it.nombre),
    cristal:safe(it.cristal),
    n_armazon: safe(it.n_armazon),
    det_armazon: safe(it.det_armazon),
    dist_focal: safe(it.dist_focal),
    vendedor: safe(it.vendedor),
    telefono: safe(it.telefono),
    pdf: safe(it.pdf),
    dLeft: daysUntil(it.retira),     // d√≠as hasta la fecha de entrega
    ready: isReady(it.estado)        // columna A = LISTO?
  };
}

/*****************************
 * ORDEN (no listos primero, por urgencia)
 *****************************/
function sortItems(){
  state.items.sort((a,b)=>{
    if(a.ready !== b.ready) return a.ready ? 1 : -1;              // NO listos arriba
    const da = a.dLeft, db = b.dLeft;
    return (da - db) || cmpDate(a.retira, b.retira) || cmpStr(a.numero, b.numero);
  });
}
function cmpStr(a,b){ return String(a).localeCompare(String(b), 'es'); }
function cmpDate(a,b){
  const da = parseDateDMY(a)?.getTime() ?? 9e15;
  const db = parseDateDMY(b)?.getTime() ?? 9e15;
  return da - db;
}

/*****************************
 * RENDER + colores por estado/fecha
 *****************************/
function rowClass(it){
  if(it.ready) return 'ready';           // verde
  const d = it.dLeft;
  if (d <= 1) return 'alert-red';        // hoy / ma√±ana / vencido
  if (d <= 3) return 'alert-orange';     // 2-3 d√≠as
  return '';
}
function badgeTexto(it){
  if(it.ready) return 'LISTO';
  const d = it.dLeft;
  if (!isFinite(d)) return '';
  if (d < 0) return `VENCIDO ${Math.abs(d)}d`;
  if (d === 0) return 'HOY';
  if (d === 1) return 'MA√ëANA';
  return `EN ${d}d`;
}

function render(){
  const tbody = $('tbody');
  tbody.innerHTML = '';
  for(const it of state.items){
    const tr = document.createElement('tr');
    tr.className = rowClass(it);
    const badge = badgeTexto(it);
    tr.innerHTML = `
      <td class="mono">${safe(it.fecha)}</td>
      <td class="mono">${safe(it.numero)}</td>
      <td>${safe(it.nombre)}</td>
      <td class="mono">${safe(it.dni)}</td>
      <td class="mono">${safe(it.telefono)}</td>
      <td>${safe(it.det_armazon)}</td>
      <td>${safe(it.cristal)}</td>
      <td class="right mono"></td>
      <td class="right mono"></td>
      <td class="right mono"></td>
      <td>
        <span class="state ${it.ready ? 'OK' : (it.dLeft<=1?'PEND':'LAB')}">${safe(it.estado|| (it.ready?'LISTO':'PEND.'))}</span>
      </td>
      <td class="mono">${safe(it.retira)} ${badge?`<span class="pill" style="margin-left:6px">${badge}</span>`:''}</td>
      <td>${safe(it.vendedor)}</td>
    `;
    tr.title = 'Click para copiar N¬∞ de trabajo';
    tr.addEventListener('click', ()=> copyNumero(it));
    tbody.appendChild(tr);
  }
  // Contadores
  $('count').textContent = String(state.items.length);
  $('total').textContent = state.total ? String(state.total) : '‚Äî';
  $('pageInfo').textContent = `Cargados: ${state.limitLoaded}`;
}

function copyNumero(it){
  const nro = it.numero || '';
  if(!nro) return;
  navigator.clipboard?.writeText(String(nro));
}

/*****************************
 * UI EVENTS + scroll (aumenta l√≠mite y recarga)
 *****************************/
const toggleProgress = (on)=> $('progress').classList.toggle('show', !!on);

$('btnLoad').addEventListener('click', ()=>{ state.query=$('q').value.trim(); resetAndLoad(); });
$('btnClear').addEventListener('click', ()=>{ $('q').value=''; state.query=''; resetAndLoad(); });
$('limit').addEventListener('change', ()=>{ state.pageStep = Number($('limit').value||100); resetAndLoad(); });
// El <select id="sort"> queda sin uso; el orden es el de la regla anterior.
$('sort').addEventListener('change', ()=>{ render(); });
$('q').addEventListener('keyup', (e)=>{ if(e.key==='Enter'){ state.query=$('q').value.trim(); resetAndLoad(); } });

function resetAndLoad(){
  state.limitLoaded = state.pageStep; fetchTrabajos();
}

document.getElementById('scroller').addEventListener('scroll', debounce(()=>{
  const el = document.getElementById('scroller');
  if (state.loading) return;
  const nearBottom = el.scrollTop + el.clientHeight >= el.scrollHeight - 120;
  if (nearBottom){ state.limitLoaded += state.pageStep; fetchTrabajos(); }
}, 120));

/*****************************
 * ARRANQUE
 *****************************/
document.getElementById('limit').value = '100';
state.pageStep = 100;
resetAndLoad();
</script>
</body>
</html>
